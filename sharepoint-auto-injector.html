<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power BI Chatbot Auto-Injector</title>
</head>
<body>
    <script>
        // SharePoint-hosted Power BI Chatbot Auto-Injector
        // This script automatically injects the chatbot when users visit Power BI
        
        (function() {
            'use strict';
            
            console.log('ü§ñ SharePoint Power BI Chatbot Auto-Injector Starting...');
            
            // Wait for page to be ready
            function waitForPowerBI() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initializeChatbot);
                } else {
                    initializeChatbot();
                }
            }
            
            function initializeChatbot() {
                console.log('üöÄ Initializing Power BI Chatbot...');
                
                // Check if already loaded
                if (window.sharePointPowerBIChatbot) {
                    console.log('‚ö†Ô∏è Chatbot already loaded');
                    return;
                }
                
                window.sharePointPowerBIChatbot = true;
                
                // Inject chatbot styles
                const chatbotStyles = document.createElement('style');
                chatbotStyles.innerHTML = `
                    #sp-pbi-auto-chatbot {
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        width: 350px;
                        height: 450px;
                        background: linear-gradient(135deg, #0078d4, #106ebe);
                        border-radius: 20px;
                        box-shadow: 0 15px 35px rgba(0,0,0,0.25);
                        z-index: 999999;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        color: white;
                        overflow: hidden;
                        transition: all 0.3s ease;
                        opacity: 0;
                        transform: translateY(100px);
                        animation: slideUp 0.5s ease forwards;
                    }
                    
                    @keyframes slideUp {
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    
                    #sp-pbi-auto-chatbot.minimized {
                        height: 60px;
                        width: 250px;
                    }
                    
                    .sp-auto-header {
                        padding: 15px;
                        background: rgba(255,255,255,0.15);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        cursor: move;
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                    }
                    
                    .sp-auto-title {
                        font-weight: bold;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    
                    .sp-auto-controls {
                        display: flex;
                        gap: 8px;
                    }
                    
                    .sp-auto-btn {
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: background 0.2s;
                    }
                    
                    .sp-auto-btn:hover {
                        background: rgba(255,255,255,0.3);
                    }
                    
                    .sp-auto-messages {
                        height: 290px;
                        overflow-y: auto;
                        padding: 15px;
                        font-size: 14px;
                    }
                    
                    .sp-auto-msg {
                        background: rgba(255,255,255,0.15);
                        margin: 10px 0;
                        padding: 12px;
                        border-radius: 10px;
                        line-height: 1.4;
                        word-wrap: break-word;
                    }
                    
                    .sp-auto-user-msg {
                        background: rgba(255,255,255,0.25);
                        text-align: right;
                        margin-left: 30px;
                    }
                    
                    .sp-auto-input-area {
                        padding: 15px;
                        display: flex;
                        gap: 10px;
                        background: rgba(255,255,255,0.1);
                        border-top: 1px solid rgba(255,255,255,0.1);
                    }
                    
                    #sp-auto-input {
                        flex: 1;
                        padding: 10px;
                        border: none;
                        border-radius: 8px;
                        outline: none;
                        font-size: 14px;
                        font-family: inherit;
                    }
                    
                    #sp-auto-send {
                        background: white;
                        color: #0078d4;
                        border: none;
                        padding: 10px 15px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: bold;
                        font-size: 14px;
                        transition: all 0.2s;
                    }
                    
                    #sp-auto-send:hover {
                        background: #f0f0f0;
                        transform: translateY(-1px);
                    }
                    
                    .sp-auto-voice-btn {
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 10px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s;
                    }
                    
                    .sp-auto-voice-btn:hover {
                        background: #c82333;
                    }
                    
                    .sp-auto-voice-btn.listening {
                        background: #28a745;
                        animation: pulse 1s infinite;
                    }
                    
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.7; }
                    }
                    
                    /* Mobile responsive */
                    @media (max-width: 500px) {
                        #sp-pbi-auto-chatbot {
                            width: calc(100vw - 20px);
                            height: 400px;
                            bottom: 10px;
                            right: 10px;
                            left: 10px;
                        }
                        
                        .sp-auto-messages {
                            height: 240px;
                        }
                    }
                    
                    /* Hidden elements when minimized */
                    #sp-pbi-auto-chatbot.minimized .sp-auto-messages,
                    #sp-pbi-auto-chatbot.minimized .sp-auto-input-area {
                        display: none;
                    }
                    
                    /* Status indicator */
                    .sp-auto-status {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 8px 15px;
                        border-radius: 15px;
                        font-size: 12px;
                        font-weight: bold;
                        z-index: 1000000;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }
                `;
                document.head.appendChild(chatbotStyles);
                
                // Create chatbot HTML
                const chatbotHTML = `
                    <div class="sp-auto-header">
                        <span class="sp-auto-title">
                            <span>ü§ñ</span>
                            <span>Power BI Assistant</span>
                        </span>
                        <div class="sp-auto-controls">
                            <button class="sp-auto-btn" onclick="window.toggleAutoChatbot()" title="Minimize">‚àí</button>
                            <button class="sp-auto-btn" onclick="window.closeAutoChatbot()" title="Close">√ó</button>
                        </div>
                    </div>
                    <div class="sp-auto-messages" id="sp-auto-messages">
                        <div class="sp-auto-msg">
                            <strong>üéâ Auto-loaded from SharePoint!</strong><br><br>
                            <b>üìã Voice Commands:</b><br>
                            ‚Ä¢ "reset all filters"<br>
                            ‚Ä¢ "go to page 2"<br>
                            ‚Ä¢ "refresh page"<br>
                            ‚Ä¢ "help"<br><br>
                            <b>üé§ Voice:</b> Click üéôÔ∏è to speak<br>
                            <b>üí¨ Text:</b> Type below
                        </div>
                    </div>
                    <div class="sp-auto-input-area">
                        <button class="sp-auto-voice-btn" onclick="window.startAutoVoice()" id="autoVoiceBtn" title="Voice Command">üéôÔ∏è</button>
                        <input type="text" id="sp-auto-input" placeholder="Type your command..." />
                        <button id="sp-auto-send" onclick="window.sendAutoMessage()">Send</button>
                    </div>
                `;
                
                // Create and insert chatbot
                const chatbotDiv = document.createElement('div');
                chatbotDiv.id = 'sp-pbi-auto-chatbot';
                chatbotDiv.innerHTML = chatbotHTML;
                document.body.appendChild(chatbotDiv);
                
                // Show status
                showAutoStatus('ü§ñ Chatbot loaded from SharePoint!');
                
                // Make draggable
                makeDraggable();
                
                // Setup event listeners
                setupEventListeners();
                
                console.log('‚úÖ SharePoint Power BI Chatbot loaded successfully!');
            }
            
            function showAutoStatus(message, duration = 3000) {
                const existingStatus = document.getElementById('autoStatus');
                if (existingStatus) existingStatus.remove();
                
                const status = document.createElement('div');
                status.id = 'autoStatus';
                status.className = 'sp-auto-status';
                status.textContent = message;
                document.body.appendChild(status);
                
                setTimeout(() => status.style.opacity = '1', 100);
                setTimeout(() => {
                    status.style.opacity = '0';
                    setTimeout(() => status.remove(), 300);
                }, duration);
            }
            
            function makeDraggable() {
                const chatbot = document.getElementById('sp-pbi-auto-chatbot');
                const header = chatbot.querySelector('.sp-auto-header');
                
                let isDragging = false;
                let currentX, currentY, initialX, initialY;
                
                header.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);
                
                function dragStart(e) {
                    if (e.target.tagName === 'BUTTON') return;
                    
                    initialX = e.clientX - chatbot.offsetLeft;
                    initialY = e.clientY - chatbot.offsetTop;
                    isDragging = true;
                    header.style.cursor = 'grabbing';
                }
                
                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                        
                        // Keep within viewport
                        const maxX = window.innerWidth - chatbot.offsetWidth;
                        const maxY = window.innerHeight - chatbot.offsetHeight;
                        
                        currentX = Math.max(0, Math.min(currentX, maxX));
                        currentY = Math.max(0, Math.min(currentY, maxY));
                        
                        chatbot.style.left = currentX + 'px';
                        chatbot.style.top = currentY + 'px';
                        chatbot.style.right = 'auto';
                        chatbot.style.bottom = 'auto';
                    }
                }
                
                function dragEnd() {
                    isDragging = false;
                    header.style.cursor = 'move';
                }
            }
            
            function setupEventListeners() {
                // Enter key support
                document.getElementById('sp-auto-input').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        window.sendAutoMessage();
                    }
                });
            }
            
            // Global functions
            window.toggleAutoChatbot = function() {
                const chatbot = document.getElementById('sp-pbi-auto-chatbot');
                chatbot.classList.toggle('minimized');
            };
            
            window.closeAutoChatbot = function() {
                const chatbot = document.getElementById('sp-pbi-auto-chatbot');
                chatbot.style.animation = 'slideDown 0.3s ease forwards';
                setTimeout(() => {
                    chatbot.remove();
                    window.sharePointPowerBIChatbot = false;
                }, 300);
            };
            
            // Add slide down animation
            const slideDownStyle = document.createElement('style');
            slideDownStyle.innerHTML = `
                @keyframes slideDown {
                    to {
                        opacity: 0;
                        transform: translateY(100px);
                    }
                }
            `;
            document.head.appendChild(slideDownStyle);
            
            // Message handling
            function addAutoMessage(text, isUser = false) {
                const messagesDiv = document.getElementById('sp-auto-messages');
                const msgDiv = document.createElement('div');
                msgDiv.className = isUser ? 'sp-auto-msg sp-auto-user-msg' : 'sp-auto-msg';
                msgDiv.innerHTML = text;
                messagesDiv.appendChild(msgDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                // Limit message history
                while (messagesDiv.children.length > 20) {
                    messagesDiv.removeChild(messagesDiv.firstChild);
                }
            }
            
            // Enhanced command processing
            function processAutoCommand(command) {
                const cmd = command.toLowerCase().trim();
                let response = '';
                let actionCount = 0;
                
                if (cmd.includes('reset') && (cmd.includes('all') || cmd.includes('filter'))) {
                    // Enhanced reset with multiple strategies
                    const resetStrategies = [
                        // Strategy 1: Common reset selectors
                        () => {
                            const selectors = [
                                'button[title*="clear" i], button[title*="reset" i]',
                                'a[title*="clear" i], a[title*="reset" i]',
                                '[aria-label*="clear" i], [aria-label*="reset" i]',
                                '.slicer-revert, .filter-clear, .clear-filters'
                            ];
                            
                            selectors.forEach(selector => {
                                try {
                                    document.querySelectorAll(selector).forEach(el => {
                                        el.click();
                                        actionCount++;
                                    });
                                } catch(e) {}
                            });
                        },
                        
                        // Strategy 2: Text-based search
                        () => {
                            document.querySelectorAll('button, a, span').forEach(el => {
                                const text = (el.textContent || el.title || '').toLowerCase();
                                if ((text.includes('reset') || text.includes('clear')) && 
                                    (text.includes('all') || text.includes('filter'))) {
                                    try {
                                        el.click();
                                        actionCount++;
                                    } catch(e) {}
                                }
                            });
                        },
                        
                        // Strategy 3: Power BI specific
                        () => {
                            // Look for Power BI filter controls
                            document.querySelectorAll('[data-testid*="slicer"], [class*="slicer"]').forEach(slicer => {
                                const clearBtn = slicer.querySelector('button, a');
                                if (clearBtn) {
                                    try {
                                        clearBtn.click();
                                        actionCount++;
                                    } catch(e) {}
                                }
                            });
                        }
                    ];
                    
                    // Execute all strategies
                    resetStrategies.forEach(strategy => strategy());
                    
                    if (actionCount > 0) {
                        response = `‚úÖ <strong>Reset Successful!</strong><br>Executed ${actionCount} reset actions<br><small>Filters should be cleared now</small>`;
                        showAutoStatus(`üîÑ Reset ${actionCount} filters`);
                    } else {
                        response = '‚ö†Ô∏è <strong>No Reset Controls Found</strong><br>Try manually clearing filters or check if filters exist';
                    }
                    
                } else if (cmd.includes('page')) {
                    const pageMatch = cmd.match(/page.*?(\d+)/);
                    if (pageMatch) {
                        const pageNum = pageMatch[1];
                        let found = false;
                        
                        // Enhanced page navigation
                        const pageSelectors = [
                            `a:contains("${pageNum}")`,
                            `button:contains("${pageNum}")`,
                            `[aria-label*="page ${pageNum}" i]`,
                            `[title*="page ${pageNum}" i]`
                        ];
                        
                        document.querySelectorAll('a, button, span, div').forEach(el => {
                            const text = el.textContent.trim();
                            if (text === pageNum || text === `Page ${pageNum}` || text.includes(`Page ${pageNum}`)) {
                                try {
                                    el.click();
                                    found = true;
                                    showAutoStatus(`üìÑ Navigated to page ${pageNum}`);
                                } catch(e) {}
                            }
                        });
                        
                        response = found ? 
                            `‚úÖ <strong>Navigation Successful!</strong><br>Moved to page ${pageNum}` :
                            `‚ùå <strong>Page Not Found</strong><br>Page ${pageNum} is not available or visible`;
                    } else {
                        response = '‚ùå <strong>Invalid Page Command</strong><br>Say "go to page 2" with a specific page number';
                    }
                    
                } else if (cmd.includes('refresh') || cmd.includes('reload')) {
                    response = 'üîÑ <strong>Refreshing Page...</strong>';
                    showAutoStatus('üîÑ Refreshing Power BI');
                    setTimeout(() => location.reload(), 1000);
                    
                } else if (cmd.includes('help') || cmd.includes('command')) {
                    response = `
                        <strong>üéØ Available Commands:</strong><br>
                        ‚Ä¢ <b>"reset all filters"</b> - Clear all active filters<br>
                        ‚Ä¢ <b>"go to page 2"</b> - Navigate to specific page<br>
                        ‚Ä¢ <b>"refresh page"</b> - Reload current page<br>
                        ‚Ä¢ <b>"help"</b> - Show this command list<br><br>
                        <strong>üé§ Voice Commands:</strong> Click üéôÔ∏è and speak!<br>
                        <strong>üí° Tip:</strong> Be specific with page numbers and filter names
                    `;
                } else {
                    response = `
                        ‚ùì <strong>Command Not Recognized</strong><br>
                        Try: <b>"reset all filters"</b>, <b>"go to page 2"</b>, or <b>"help"</b><br>
                        <small>Use natural language for best results</small>
                    `;
                }
                
                addAutoMessage(response);
            }
            
            // Send message function
            window.sendAutoMessage = function() {
                const input = document.getElementById('sp-auto-input');
                const message = input.value.trim();
                
                if (message) {
                    addAutoMessage(message, true);
                    processAutoCommand(message);
                    input.value = '';
                    input.focus();
                }
            };
            
            // Voice recognition
            window.startAutoVoice = function() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    addAutoMessage('‚ùå <strong>Voice Not Supported</strong><br>Your browser doesn\'t support voice recognition. Use text input instead.');
                    return;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                const voiceBtn = document.getElementById('autoVoiceBtn');
                voiceBtn.classList.add('listening');
                voiceBtn.textContent = 'üî¥';
                addAutoMessage('üé§ <strong>Listening...</strong> Speak your command now!');
                showAutoStatus('üé§ Listening for voice command...');
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    addAutoMessage(transcript, true);
                    processAutoCommand(transcript);
                    showAutoStatus(`üé§ Heard: "${transcript}"`);
                };
                
                recognition.onerror = function(event) {
                    addAutoMessage(`‚ùå <strong>Voice Error:</strong> ${event.error}<br><small>Try speaking again or use text input</small>`);
                    showAutoStatus('‚ùå Voice recognition failed');
                };
                
                recognition.onend = function() {
                    voiceBtn.classList.remove('listening');
                    voiceBtn.textContent = 'üéôÔ∏è';
                };
                
                try {
                    recognition.start();
                } catch(e) {
                    addAutoMessage('‚ùå <strong>Voice Error:</strong> Could not start recognition');
                    voiceBtn.classList.remove('listening');
                    voiceBtn.textContent = 'üéôÔ∏è';
                }
            };
            
            // Start the chatbot
            waitForPowerBI();
            
        })();
    </script>
</body>
</html>
